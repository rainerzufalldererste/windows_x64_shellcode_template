#include <stdint.h>
#include <inttypes.h>
#include <stdio.h>

#define WIN32_LEAN_AND_MEAN
#include <windows.h>
#include <memoryapi.h>

const uint8_t shellcode[] = { 
  0x48, 0x89, 0x5C, 0x24, 0x08, 0x57, 0x48, 0x83, 0xEC, 0x30, 0x65, 0x48, 0x8B, 0x04, 0x25, 0x60,
  0x00, 0x00, 0x00, 0x31, 0xD2, 0x49, 0xB9, 0x47, 0x65, 0x74, 0x50, 0x72, 0x6F, 0x63, 0x41, 0x48,
  0x8B, 0x48, 0x18, 0x48, 0x8B, 0x41, 0x20, 0x48, 0x8B, 0x08, 0x48, 0x8B, 0x01, 0x48, 0x8B, 0x78,
  0x20, 0x48, 0x63, 0x47, 0x3C, 0x44, 0x8B, 0x84, 0x38, 0x88, 0x00, 0x00, 0x00, 0x41, 0x8B, 0x44,
  0x38, 0x20, 0x48, 0x01, 0xF8, 0x48, 0x63, 0x08, 0x4C, 0x39, 0x0C, 0x39, 0x74, 0x12, 0x90, 0x90,
  0x48, 0x63, 0x48, 0x04, 0x48, 0x8D, 0x40, 0x04, 0xFF, 0xC2, 0x4C, 0x39, 0x0C, 0x39, 0x75, 0xF0,
  0x41, 0x8B, 0x4C, 0x38, 0x1C, 0x48, 0xB8, 0x4C, 0x6F, 0x61, 0x64, 0x4C, 0x69, 0x62, 0x72, 0x48,
  0x01, 0xF9, 0x48, 0x63, 0xD2, 0x48, 0x63, 0x1C, 0x91, 0x48, 0x8D, 0x54, 0x24, 0x20, 0x48, 0x01,
  0xFB, 0x48, 0x89, 0x44, 0x24, 0x20, 0x48, 0x89, 0xF9, 0x48, 0xC7, 0x44, 0x24, 0x28, 0x61, 0x72,
  0x79, 0x41, 0xFF, 0xD3, 0x48, 0xB9, 0x75, 0x73, 0x65, 0x72, 0x33, 0x32, 0x2E, 0x64, 0x48, 0xC7,
  0x44, 0x24, 0x28, 0x6C, 0x6C, 0x00, 0x00, 0x48, 0x89, 0x4C, 0x24, 0x20, 0x48, 0x8D, 0x4C, 0x24,
  0x20, 0xFF, 0xD0, 0x48, 0xB9, 0x4D, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x42, 0x48, 0xC7, 0x44,
  0x24, 0x28, 0x6F, 0x78, 0x41, 0x00, 0x48, 0x89, 0x4C, 0x24, 0x20, 0x48, 0x8D, 0x54, 0x24, 0x20,
  0x48, 0x89, 0xC1, 0xFF, 0xD3, 0x48, 0xB9, 0x48, 0x61, 0x73, 0x74, 0x61, 0x20, 0x6C, 0x61, 0x4C,
  0x8D, 0x44, 0x24, 0x2F, 0x48, 0x89, 0x4C, 0x24, 0x20, 0x48, 0x8D, 0x54, 0x24, 0x20, 0x48, 0xB9,
  0x20, 0x76, 0x69, 0x73, 0x74, 0x61, 0x21, 0x00, 0x45, 0x31, 0xC9, 0x48, 0x89, 0x4C, 0x24, 0x28,
  0x31, 0xC9, 0xFF, 0xD0, 0x48, 0xB8, 0x45, 0x78, 0x69, 0x74, 0x50, 0x72, 0x6F, 0x63, 0x48, 0xC7,
  0x44, 0x24, 0x28, 0x65, 0x73, 0x73, 0x00, 0x48, 0x8D, 0x54, 0x24, 0x20, 0x48, 0x89, 0x44, 0x24,
  0x20, 0x48, 0x89, 0xF9, 0xFF, 0xD3, 0xB9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x48, 0x8B, 0x5C,
  0x24, 0x40, 0x48, 0x83, 0xC4, 0x30, 0x5F, 0xC2, 0x00, 0x00
};

#ifdef _DEBUG
const char childProcessName[] = "child_processD.exe";
#else
const char childProcessName[] = "child_process.exe";
#endif

uint64_t AlignTo2k(const uint64_t value)
{
  return (value + (uint64_t)(2048 - 1)) & ~((uint64_t)(2048 - 1));
}

//////////////////////////////////////////////////////////////////////////

#pragma warning (push, 0)
int32_t main()
{
  STARTUPINFOA startupInfo;
  PROCESS_INFORMATION processInfo;

  ZeroMemory(&startupInfo, sizeof(STARTUPINFO));
  startupInfo.cb = sizeof(startupInfo);

  ZeroMemory(&processInfo, sizeof(PROCESS_INFORMATION));

  if (!CreateProcessA(childProcessName, "", NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &startupInfo, &processInfo))
  {
    printf("Failed to launch process. (Error code %" PRIu32 ")\n", GetLastError());
    return -1;
  }

  Sleep(2000); // Let the child process live for a while.

  void *pData = VirtualAllocEx(processInfo.hProcess, NULL, AlignTo2k(sizeof(shellcode)), MEM_COMMIT, PAGE_EXECUTE_READWRITE);

  if (pData == NULL)
  {
    printf("Failed to allocate memory in child process. (Error code %" PRIu32 ")\n", GetLastError());
    return -1;
  }

  size_t bytesWritten = 0;

  if (!WriteProcessMemory(processInfo.hProcess, pData, shellcode, sizeof(shellcode), &bytesWritten) || bytesWritten != sizeof(shellcode))
  {
    printf("Failed to write shellcode to child process memory. (Error code %" PRIu32 ")\n", GetLastError());
    return -1;
  }

  DWORD threadId = 0;

  if (!CreateRemoteThread(processInfo.hProcess, NULL, 0, (PTHREAD_START_ROUTINE)pData, NULL, 0, &threadId))
  {
    printf("Failed to create remote thread. (Error code %" PRIu32 ")\n", GetLastError());
    return -1;
  }

  WaitForSingleObject(processInfo.hThread, INFINITE); // This should not be able to fail.

  DWORD exitCode = 0;

  if (!GetExitCodeProcess(processInfo.hProcess, &exitCode))
  {
    printf("Failed to retrieve exit code. (Error code %" PRIu32 ")\n", GetLastError());
    return -1;
  }

  printf("Remote Thread terminated with exit code %" PRIu32 ".\n", exitCode);

  CloseHandle(processInfo.hThread);
  CloseHandle(processInfo.hProcess);

  return 0;
}
#pragma warning (pop)